<mat-card class="review-table-card">
  <mat-card-header>
    <mat-card-title>
      <mat-checkbox
        [checked]="allSelected()"
        [indeterminate]="someSelected()"
        (change)="toggleMasterSelection()"
        matTooltip="Zaznacz/odznacz wszystkie"
      >
      </mat-checkbox>
      Produkty do przeglądu
    </mat-card-title>
    <mat-card-subtitle>
      Kliknij na produkt aby go edytować, lub użyj przełączników aby wykluczyć z listy
    </mat-card-subtitle>
  </mat-card-header>

  <!-- Toolbar with view controls -->
  <div class="toolbar">
    <!-- View mode toggle -->
    <mat-button-toggle-group
      [value]="viewMode()"
      (change)="viewMode.set($event.value)"
      class="view-toggle"
    >
      <mat-button-toggle value="table" matTooltip="Widok tabeli">
        <mat-icon>table_view</mat-icon>
      </mat-button-toggle>
      <mat-button-toggle value="grouped" matTooltip="Widok grupowany">
        <mat-icon>view_list</mat-icon>
      </mat-button-toggle>
    </mat-button-toggle-group>

    <!-- Sorting controls -->
    <div class="sort-controls">
      <span class="sort-label">Sortuj:</span>
      <button
        mat-button
        (click)="setSortField('product_name')"
        [class.active]="sortField() === 'product_name'"
      >
        Nazwa
        <mat-icon>{{ getSortIcon('product_name') }}</mat-icon>
      </button>
      <button
        mat-button
        (click)="setSortField('quantity')"
        [class.active]="sortField() === 'quantity'"
      >
        Ilość
        <mat-icon>{{ getSortIcon('quantity') }}</mat-icon>
      </button>
      <button
        mat-button
        (click)="setSortField('category')"
        [class.active]="sortField() === 'category'"
      >
        Kategoria
        <mat-icon>{{ getSortIcon('category') }}</mat-icon>
      </button>
    </div>
  </div>

  <mat-card-content>
    <!-- Table View -->
    @if (viewMode() === 'table') {
      <div class="table-container">
        <table mat-table [dataSource]="sortedItems()" class="review-table">
          <!-- Exclude Column -->
          <ng-container matColumnDef="exclude">
            <th mat-header-cell *matHeaderCellDef class="exclude-column">
              <span>Dodaj</span>
            </th>
            <td mat-cell *matCellDef="let item" class="exclude-column">
              <mat-checkbox
                [checked]="!item.excluded"
                (change)="toggleItemSelection(item)"
                [matTooltip]="item.excluded ? 'Dodaj do listy' : 'Wyklucz z listy'"
              >
              </mat-checkbox>
            </td>
          </ng-container>

          <!-- Product Name Column -->
          <ng-container matColumnDef="product_name">
            <th mat-header-cell *matHeaderCellDef>Nazwa produktu</th>
            <td mat-cell *matCellDef="let item" [class.excluded]="item.excluded">
              @if (item.isEditing) {
                <mat-form-field appearance="outline" class="edit-field">
                  <input
                    matInput
                    [formControl]="item.editForm!.product_name"
                    placeholder="Nazwa produktu"
                  />
                  @if (item.editForm!.product_name.hasError('required')) {
                    <mat-error>Nazwa jest wymagana</mat-error>
                  }
                </mat-form-field>
              } @else {
                <span class="product-name" [class.modified]="item.isModified">
                  {{ item.product_name }}
                  @if (item.isModified) {
                    <mat-icon class="modified-icon" matTooltip="Zmodyfikowane">edit</mat-icon>
                  }
                </span>
              }
            </td>
          </ng-container>

          <!-- Quantity Column -->
          <ng-container matColumnDef="quantity">
            <th mat-header-cell *matHeaderCellDef>Ilość</th>
            <td mat-cell *matCellDef="let item" [class.excluded]="item.excluded">
              @if (item.isEditing) {
                <mat-form-field appearance="outline" class="edit-field quantity-field">
                  <input
                    matInput
                    type="number"
                    [formControl]="item.editForm!.quantity"
                    placeholder="Ilość"
                    min="0.01"
                    step="0.01"
                  />
                  @if (item.editForm!.quantity.hasError('required')) {
                    <mat-error>Ilość jest wymagana</mat-error>
                  }
                  @if (item.editForm!.quantity.hasError('min')) {
                    <mat-error>Ilość musi być większa od 0</mat-error>
                  }
                </mat-form-field>
              } @else {
                <span>{{ item.quantity }}</span>
              }
            </td>
          </ng-container>

          <!-- Unit Column -->
          <ng-container matColumnDef="unit">
            <th mat-header-cell *matHeaderCellDef>Jednostka</th>
            <td mat-cell *matCellDef="let item" [class.excluded]="item.excluded">
              @if (item.isEditing) {
                <mat-form-field appearance="outline" class="edit-field unit-field">
                  <mat-select [formControl]="item.editForm!.unit" placeholder="Jednostka">
                    @for (unit of standardUnits; track unit) {
                      <mat-option [value]="unit">{{ unit }}</mat-option>
                    }
                  </mat-select>
                  @if (item.editForm!.unit.hasError('required')) {
                    <mat-error>Jednostka jest wymagana</mat-error>
                  }
                </mat-form-field>
              } @else {
                <span>{{ item.unit }}</span>
              }
            </td>
          </ng-container>

          <!-- Category Column -->
          <ng-container matColumnDef="category">
            <th mat-header-cell *matHeaderCellDef>Kategoria</th>
            <td mat-cell *matCellDef="let item" [class.excluded]="item.excluded">
              @if (item.isEditing) {
                <mat-form-field appearance="outline" class="edit-field category-field">
                  <mat-select [formControl]="item.editForm!.category_id" placeholder="Kategoria">
                    @for (category of categories; track category.id) {
                      <mat-option [value]="category.id">{{ category.name }}</mat-option>
                    }
                  </mat-select>
                  @if (item.editForm!.category_id.hasError('required')) {
                    <mat-error>Kategoria jest wymagana</mat-error>
                  }
                </mat-form-field>
              } @else {
                <span>{{ getCategoryName(item.category_id) }}</span>
              }
            </td>
          </ng-container>

          <!-- Actions Column -->
          <ng-container matColumnDef="actions">
            <th mat-header-cell *matHeaderCellDef class="actions-column">Akcje</th>
            <td mat-cell *matCellDef="let item" class="actions-column">
              @if (item.isEditing) {
                <div class="edit-actions">
                  <button
                    mat-icon-button
                    color="primary"
                    (click)="saveEdit(item)"
                    [disabled]="
                      item.editForm!.product_name.invalid ||
                      item.editForm!.quantity.invalid ||
                      item.editForm!.unit.invalid ||
                      item.editForm!.category_id.invalid
                    "
                    matTooltip="Zapisz zmiany"
                  >
                    <mat-icon>check</mat-icon>
                  </button>
                  <button mat-icon-button (click)="cancelEdit(item)" matTooltip="Anuluj edycję">
                    <mat-icon>close</mat-icon>
                  </button>
                </div>
              } @else {
                <button
                  mat-icon-button
                  (click)="startEdit(item)"
                  [disabled]="item.excluded"
                  matTooltip="Edytuj produkt"
                >
                  <mat-icon>edit</mat-icon>
                </button>
              }
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
          <tr
            mat-row
            *matRowDef="let row; columns: displayedColumns"
            [class.excluded-row]="row.excluded"
          ></tr>
        </table>

        @if (editableItems().length === 0) {
          <div class="no-items">
            <mat-icon>inbox</mat-icon>
            <p>Brak produktów do przeglądu</p>
          </div>
        }
      </div>
    }

    <!-- Grouped View -->
    @if (viewMode() === 'grouped') {
      <div class="grouped-container">
        @if (groupedItems().length === 0) {
          <div class="no-items">
            <mat-icon>inbox</mat-icon>
            <p>Brak produktów do przeglądu</p>
          </div>
        } @else {
          <div class="grouped-table">
            @for (group of groupedItems(); track group.categoryId) {
              <!-- Category Header Row -->
              <div class="category-header-row">
                <div class="category-info">
                  <h3 class="category-name">{{ group.categoryName }}</h3>
                  <div class="category-stats">
                    <span class="stat-item">{{ group.items.length }} produktów</span>
                    <span
                      class="stat-item"
                      [class.has-excluded]="hasGroupExcludedItems(group.items)"
                    >
                      {{ getGroupIncludedCount(group.items) }} dołączonych
                    </span>
                  </div>
                </div>
              </div>

              <!-- Category Items -->
              <div class="category-items">
                @for (item of group.items; track item.id) {
                  <div class="grouped-item" [class.excluded-item]="item.excluded">
                    <div class="item-checkbox">
                      <mat-checkbox
                        [checked]="!item.excluded"
                        (change)="toggleItemSelection(item)"
                        [matTooltip]="item.excluded ? 'Dodaj do listy' : 'Wyklucz z listy'"
                      >
                      </mat-checkbox>
                    </div>

                    <div class="item-content">
                      @if (item.isEditing) {
                        <div class="edit-form">
                          <mat-form-field appearance="outline" class="edit-field">
                            <mat-label>Nazwa produktu</mat-label>
                            <input matInput [formControl]="item.editForm!.product_name" />
                            @if (item.editForm!.product_name.hasError('required')) {
                              <mat-error>Nazwa jest wymagana</mat-error>
                            }
                          </mat-form-field>

                          <div class="quantity-unit-row">
                            <mat-form-field appearance="outline" class="quantity-field">
                              <mat-label>Ilość</mat-label>
                              <input
                                matInput
                                type="number"
                                [formControl]="item.editForm!.quantity"
                                min="0.01"
                                step="0.01"
                              />
                              @if (item.editForm!.quantity.hasError('required')) {
                                <mat-error>Ilość jest wymagana</mat-error>
                              }
                              @if (item.editForm!.quantity.hasError('min')) {
                                <mat-error>Ilość musi być większa od 0</mat-error>
                              }
                            </mat-form-field>

                            <mat-form-field appearance="outline" class="unit-field">
                              <mat-label>Jednostka</mat-label>
                              <mat-select [formControl]="item.editForm!.unit">
                                @for (unit of standardUnits; track unit) {
                                  <mat-option [value]="unit">{{ unit }}</mat-option>
                                }
                              </mat-select>
                              @if (item.editForm!.unit.hasError('required')) {
                                <mat-error>Jednostka jest wymagana</mat-error>
                              }
                            </mat-form-field>
                          </div>

                          <mat-form-field appearance="outline" class="category-field">
                            <mat-label>Kategoria</mat-label>
                            <mat-select [formControl]="item.editForm!.category_id">
                              @for (category of categories; track category.id) {
                                <mat-option [value]="category.id">{{ category.name }}</mat-option>
                              }
                            </mat-select>
                            @if (item.editForm!.category_id.hasError('required')) {
                              <mat-error>Kategoria jest wymagana</mat-error>
                            }
                          </mat-form-field>

                          <div class="edit-actions">
                            <button
                              mat-raised-button
                              color="primary"
                              (click)="saveEdit(item)"
                              [disabled]="
                                item.editForm!.product_name.invalid ||
                                item.editForm!.quantity.invalid ||
                                item.editForm!.unit.invalid ||
                                item.editForm!.category_id.invalid
                              "
                            >
                              <mat-icon>check</mat-icon>
                              Zapisz
                            </button>
                            <button mat-button (click)="cancelEdit(item)">
                              <mat-icon>close</mat-icon>
                              Anuluj
                            </button>
                          </div>
                        </div>
                      } @else {
                        <div class="item-display">
                          <div class="item-name">
                            <span [class.modified]="item.isModified">{{ item.product_name }}</span>
                            @if (item.isModified) {
                              <mat-icon class="modified-icon" matTooltip="Zmodyfikowane"
                                >edit</mat-icon
                              >
                            }
                          </div>
                          <div class="item-details">
                            <span class="quantity">{{ item.quantity }} {{ item.unit }}</span>
                          </div>
                        </div>
                      }
                    </div>

                    <div class="item-actions">
                      @if (item.isEditing) {
                        <!-- Actions are in the edit form -->
                      } @else {
                        <button
                          mat-icon-button
                          (click)="startEdit(item)"
                          [disabled]="item.excluded"
                          matTooltip="Edytuj produkt"
                        >
                          <mat-icon>edit</mat-icon>
                        </button>
                      }
                    </div>
                  </div>
                }
              </div>
            }
          </div>
        }
      </div>
    }
  </mat-card-content>
</mat-card>
